<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DIGIY DRIVER ‚Äî Chauffeur (Realtime + GEO)</title>
  <meta name="theme-color" content="#22c55e" />
  <meta name="description" content="DIGIY DRIVER Chauffeur ‚Äî tableau de bord, courses en direct, filtrage zone & distance, 0% commission." />

  <style>
    :root{
      --green:#22c55e;
      --green2:#16a34a;
      --sky:#0ea5e9;
      --ok:#22c55e;

      --bg:#f0fdf4;
      --bg2:#ffffff;
      --card:#ffffff;

      --text:#0f172a;
      --muted:#64748b;

      --shadow:0 12px 28px rgba(2,6,23,.08);
      --radius:18px;

      --warn:#f59e0b;
      --warnBg:rgba(245,158,11,.12);
      --warnBd:rgba(245,158,11,.35);
      --warnTx:#7c2d12;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #dcfce7 0%, var(--bg) 55%, var(--bg2) 100%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:5;
      padding:16px 14px;
      background: linear-gradient(90deg, var(--green), #4ade80);
      color:#fff;
      box-shadow: 0 10px 22px rgba(34,197,94,.32);
    }
    .topRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      max-width:980px; margin:0 auto;
    }
    .brand{
      font-weight:1000;
      letter-spacing:.3px;
      display:flex; align-items:center; gap:10px;
      font-size:17px;
      white-space:nowrap;
    }
    .pill{
      background: rgba(255,255,255,.22);
      border:1px solid rgba(255,255,255,.35);
      padding:7px 11px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
    }
    main{max-width:980px; margin:0 auto; padding:14px;}

    .card{
      background:#ffffffcc;
      backdrop-filter: blur(7px);
      border:1px solid rgba(15,23,42,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      margin-bottom:12px;
    }
    .bar{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    @media(max-width:860px){
      .bar{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
    }
    .field label{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      display:block;
      margin-bottom:6px;
    }
    select, input{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.12);
      outline:none;
      font-size:14px;
      background:#fff;
    }

    .status{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .status .left{display:flex; flex-direction:column; gap:2px}
    .status .title{font-weight:1000}
    .status .sub{font-size:12px; color:var(--muted); font-weight:800}
    .badge{
      font-size:12px;
      font-weight:1000;
      padding:8px 10px;
      border-radius:999px;
      background:#dcfce7;
      border:1px solid rgba(34,197,94,.22);
      color:#14532d;
      white-space:nowrap;
    }
    .badge.warn{
      background:var(--warnBg);
      border:1px solid var(--warnBd);
      color:var(--warnTx);
    }

    .actionsTop{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center;
    }
    button{
      padding:11px 12px;
      border:none;
      border-radius:14px;
      font-weight:1000;
      font-size:14px;
      cursor:pointer;
    }
    button:disabled{opacity:.55; cursor:not-allowed}
    .btn-light{
      background:#fff;
      border:1px solid rgba(15,23,42,.14);
      color:var(--text);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    .trip{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border:1px solid rgba(15,23,42,.08);
      padding:14px;
      overflow:hidden;
      position:relative;
    }
    .trip .head{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .trip .route{
      font-weight:1000;
      font-size:15px;
      line-height:1.2;
    }
    .trip .meta{
      margin-top:8px;
      display:flex; flex-wrap:wrap; gap:8px;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
    }
    .tag{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
    }
    .price{
      margin-top:10px;
      font-size:16px;
      font-weight:1100;
      color:var(--green2);
    }
    .actions{display:flex; gap:10px; margin-top:12px;}
    .btn-accept{background:var(--green2); color:#fff}
    .btn-start{background:var(--sky); color:#fff}
    .btn-done{background:var(--ok); color:#fff}
    .btn-ghost{
      background:#fff;
      border:1px solid rgba(15,23,42,.12);
      color:var(--text);
    }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 16px;
      background: rgba(15,23,42,.92);
      color:#fff;
      padding:10px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 900;
      display:none;
      z-index: 20;
      max-width: 92vw;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>

<body>
<header>
  <div class="topRow">
    <div class="brand">üöï DIGIY DRIVER <span class="pill">Personnes ‚Ä¢ Realtime</span></div>
    <div class="pill" id="who">‚Ä¶</div>
  </div>
</header>

<main>

  <div class="card">
    <div class="bar">
      <div class="field">
        <label>üìç Zone (pickup_zone)</label>
        <select id="zoneFilter">
          <option value="">Toutes</option>
          <option value="Plateau">Plateau</option>
          <option value="Almadies">Almadies</option>
          <option value="Yoff">Yoff</option>
          <option value="Saly">Saly</option>
        </select>
      </div>

      <div class="field">
        <label>üìè Rayon</label>
        <select id="radiusFilter">
          <option value="2">2 km</option>
          <option value="3">3 km</option>
          <option value="5" selected>5 km</option>
          <option value="8">8 km</option>
          <option value="10">10 km</option>
        </select>
      </div>

      <div class="field">
        <label>üéõÔ∏è Vue</label>
        <select id="viewFilter">
          <option value="open" selected>Demandes ouvertes (requested)</option>
          <option value="mine">Mes courses (accepted/ongoing)</option>
          <option value="all">Tout (requested/accepted/ongoing)</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Bandeau soft (on ne vire pas) -->
  <div class="card status" id="softCard" style="display:none">
    <div class="left">
      <div class="title" id="softTitle">‚ö†Ô∏è Profil √† compl√©ter</div>
      <div class="sub" id="softSub">On te laisse entrer. Mets tes infos chauffeur quand tu peux.</div>
    </div>
    <div class="badge warn">Soft-guard</div>
  </div>

  <div class="card status">
    <div class="left">
      <div class="title" id="statusTitle">Connexion‚Ä¶</div>
      <div class="sub" id="statusSub">Chargement Supabase / GPS</div>
    </div>
    <div class="badge" id="gpsBadge">GPS: ‚Ä¶</div>
  </div>

  <div class="card status">
    <div class="left">
      <div class="title">üë§ Dashboard Chauffeur</div>
      <div class="sub" id="meLine">Chargement profil‚Ä¶</div>
    </div>
    <div class="actionsTop">
      <button class="btn-light" id="btnReload">üîÑ Recharger</button>
      <button class="btn-light" id="btnLogout">üö™ D√©connexion</button>
    </div>
  </div>

  <div class="grid" id="trips"></div>
</main>

<div class="toast" id="toast"></div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  /* PORTE HUB */
  const DIGIY_GATE = "https://beauville.github.io/digiy-hub/";
  function STOP(){
    location.replace(DIGIY_GATE);
    throw new Error("DIGIY_GATE");
  }

  /* SUPABASE */
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  globalThis.__sb ||= createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const sb = globalThis.__sb;

  /* UI */
  const tripsEl = document.getElementById("trips");
  const zoneFilter = document.getElementById("zoneFilter");
  const radiusFilter = document.getElementById("radiusFilter");
  const viewFilter = document.getElementById("viewFilter");
  const whoEl = document.getElementById("who");
  const statusTitle = document.getElementById("statusTitle");
  const statusSub = document.getElementById("statusSub");
  const gpsBadge = document.getElementById("gpsBadge");
  const meLine = document.getElementById("meLine");
  const toastEl = document.getElementById("toast");
  const btnReload = document.getElementById("btnReload");
  const btnLogout = document.getElementById("btnLogout");
  const softCard = document.getElementById("softCard");
  const softTitle = document.getElementById("softTitle");
  const softSub = document.getElementById("softSub");

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(globalThis.__t);
    globalThis.__t = setTimeout(()=> toastEl.style.display="none", 2400);
  }

  function showSoft(title, sub){
    softTitle.textContent = title;
    softSub.textContent = sub;
    softCard.style.display = "flex";
  }

  async function main(){
    // Session obligatoire (seule vraie raison de virer)
    const { data: sess } = await sb.auth.getSession();
    const session = sess?.session;

    if (!session){
      statusTitle.textContent = "‚ùå Non connect√©";
      statusSub.textContent = "Retour HUB‚Ä¶";
      whoEl.textContent = "Offline";
      STOP();
    }

    const uid = session.user.id;
    whoEl.textContent = (session.user.phone || session.user.email || "Chauffeur");
    statusTitle.textContent = "üü¢ En ligne";
    statusSub.textContent = "Chargement profil & courses‚Ä¶";

    // Profil : on tente, mais on NE VIRE PAS si √ßa √©choue
    let profile = null;
    let profError = null;

    try{
      const res = await sb
        .from("profiles")
        .select("role_auto, pro_type, active_modules")
        .eq("id", uid)
        .maybeSingle();

      profile = res.data || null;
      profError = res.error || null;
    }catch(e){
      profError = e;
      profile = null;
    }

    // Cas clair : si profil dit FRET => dehors (seule interdiction dure)
    if (profile){
      const proType = (profile.pro_type || "").toLowerCase();
      const mods = Array.isArray(profile.active_modules) ? profile.active_modules : [];
      if (proType === "fret" || mods.includes("fret")){
        STOP();
      }
      meLine.textContent = `ID: ${uid.slice(0,6)}‚Ä¶ ‚Ä¢ ROLE: ${profile.role_auto || "?"} ‚Ä¢ TYPE: ${profile.pro_type || "?"}`;
    } else {
      // Profil absent / RLS / erreur -> SOFT ONLY
      showSoft("‚ö†Ô∏è Profil pas pr√™t", "Ton acc√®s est OK. On n‚Äôa pas encore pu lire ton profil (RLS/profil). Tu compl√®teras apr√®s.");
      meLine.textContent = `ID: ${uid.slice(0,6)}‚Ä¶ ‚Ä¢ Mode: DRIVER (soft)`;
      if (profError) console.warn("profiles read error (soft):", profError);
    }

    // Logout
    btnLogout?.addEventListener("click", async ()=>{
      await sb.auth.signOut();
      STOP();
    });

    // GPS
    let driverLat = null, driverLng = null;

    function setGPSBadge(){
      gpsBadge.textContent = (driverLat && driverLng) ? "GPS: OK" : "GPS: OFF";
    }
    setGPSBadge();

    function distanceKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2-lat1) * Math.PI/180;
      const dLon = (lon2-lon1) * Math.PI/180;
      const a =
        Math.sin(dLat/2)**2 +
        Math.cos(lat1*Math.PI/180) *
        Math.cos(lat2*Math.PI/180) *
        Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        (pos)=>{
          driverLat = pos.coords.latitude;
          driverLng = pos.coords.longitude;
          setGPSBadge();
        },
        ()=>{
          setGPSBadge();
          statusSub.textContent = "GPS refus√© ‚Ä¢ filtrage distance d√©sactiv√©";
        },
        { enableHighAccuracy:true, maximumAge: 8000, timeout: 12000 }
      );
    } else {
      statusSub.textContent = "GPS indisponible ‚Ä¢ filtrage distance d√©sactiv√©";
    }

    // Store
    const store = new Map();

    function passesFilters(trip){
      const z = zoneFilter.value;
      const r = parseFloat(radiusFilter.value || "5");
      const v = viewFilter.value;

      if (v === "open" && trip.status !== "requested") return false;
      if (v === "mine" && !(trip.status === "accepted" || trip.status === "ongoing")) return false;
      if (v === "all" && !["requested","accepted","ongoing"].includes(trip.status)) return false;

      if (z && (trip.pickup_zone || "") !== z) return false;

      if (driverLat && driverLng && trip.pickup_lat && trip.pickup_lng) {
        const d = distanceKm(driverLat, driverLng, trip.pickup_lat, trip.pickup_lng);
        if (d > r) return false;
      }
      return true;
    }

    function formatTripMeta(trip){
      const z = trip.pickup_zone ? `üìç ${trip.pickup_zone}` : "üìç Zone ?";
      const c = trip.pickup_city ? `üèôÔ∏è ${trip.pickup_city}` : "üèôÔ∏è Ville ?";

      let distStr = null;
      if (driverLat && driverLng && trip.pickup_lat && trip.pickup_lng) {
        const d = distanceKm(driverLat, driverLng, trip.pickup_lat, trip.pickup_lng);
        distStr = `üìè ${d.toFixed(1)} km`;
      }

      const km = trip.distance_km ? `üõ£Ô∏è ${trip.distance_km} km` : null;
      const min = trip.duration_min ? `‚è±Ô∏è ${trip.duration_min} min` : null;

      return [c, z, distStr, km, min].filter(Boolean);
    }

    function renderAll(){
      tripsEl.innerHTML = "";
      const items = Array.from(store.values())
        .filter(passesFilters)
        .sort((a,b)=> (new Date(b.created_at) - new Date(a.created_at)));

      if (!items.length){
        tripsEl.innerHTML = `
          <div class="trip" style="grid-column:1/-1">
            <div class="route">Aucune course dans tes filtres</div>
            <div class="meta">
              <span class="tag">Zone=Toutes</span>
              <span class="tag">Rayon=10km</span>
              <span class="tag">Vue=Demandes ouvertes</span>
            </div>
          </div>
        `;
        return;
      }

      for (const trip of items) {
        const card = document.createElement("div");
        card.className = "trip";

        const route = `üìç ${trip.pickup_city || "?"} ‚Üí ${trip.dropoff_city || "?"}`;
        const metaTags = formatTripMeta(trip).map(x=>`<span class="tag">${x}</span>`).join("");

        let actionsHtml = "";
        if (trip.status === "requested") {
          actionsHtml = `
            <div class="actions">
              <button class="btn-accept" data-id="${trip.id}" data-act="accept">Accepter</button>
            </div>
          `;
        } else if (trip.status === "accepted") {
          actionsHtml = `
            <div class="actions">
              <button class="btn-start" data-id="${trip.id}" data-act="start">D√©marrer</button>
              <button class="btn-ghost" data-id="${trip.id}" data-act="refresh">Rafra√Æchir</button>
            </div>
          `;
        } else if (trip.status === "ongoing") {
          actionsHtml = `
            <div class="actions">
              <button class="btn-done" data-id="${trip.id}" data-act="complete">Terminer</button>
              <button class="btn-ghost" data-id="${trip.id}" data-act="refresh">Rafra√Æchir</button>
            </div>
          `;
        }

        card.innerHTML = `
          <div class="head">
            <div>
              <div class="route">${route}</div>
              <div class="meta">${metaTags}</div>
              <div class="price">üí∞ ${(trip.amount ?? 0)} F CFA</div>
            </div>
            <div class="pill" style="color:#0f172a;background:#fff;border-color:rgba(15,23,42,.15)">
              ${trip.status}
            </div>
          </div>
          ${actionsHtml}
        `;

        tripsEl.appendChild(card);
      }
    }

    async function rpcAction(action, tripId){
      try{
        if (!tripId) return;

        toast(`‚è≥ ${action.toUpperCase()}‚Ä¶`);
        let res;

        if (action === "accept") res = await sb.rpc("accept_trip", { p_trip_id: tripId });
        else if (action === "start") res = await sb.rpc("start_trip", { p_trip_id: tripId });
        else if (action === "complete") res = await sb.rpc("complete_trip", { p_trip_id: tripId });
        else if (action === "refresh") { await loadInitial(); toast("‚úÖ Rafra√Æchi"); return; }
        else return;

        if (res?.error){
          console.error(res.error);
          toast("‚ùå " + res.error.message);
          return;
        }

        toast("‚úÖ OK");
      }catch(e){
        console.error(e);
        toast("‚ùå Erreur action");
      }
    }

    document.addEventListener("click", (e)=>{
      const btn = e.target?.closest("button[data-act]");
      if (!btn) return;
      rpcAction(btn.getAttribute("data-act"), btn.getAttribute("data-id"));
    });

    async function loadInitial(){
      const { data, error } = await sb
        .from("driver_trips")
        .select("*")
        .in("status", ["requested","accepted","ongoing"])
        .order("created_at", { ascending:false })
        .limit(200);

      if (error){
        console.error(error);
        statusSub.textContent = "Erreur chargement (driver_trips)";
        tripsEl.innerHTML = `
          <div class="trip" style="grid-column:1/-1">
            <div class="route">‚ö†Ô∏è driver_trips inaccessible</div>
            <div class="meta">
              <span class="tag">Table/view manquante ?</span>
              <span class="tag">RLS bloque ?</span>
            </div>
          </div>
        `;
        return;
      }

      store.clear();
      (data || []).forEach(t => t?.id && store.set(t.id, t));
      renderAll();
      statusSub.textContent = "Realtime actif ‚Ä¢ attente de courses";
    }

    btnReload?.addEventListener("click", async ()=>{
      await loadInitial();
      toast("‚úÖ Recharg√©");
    });

    zoneFilter.addEventListener("change", renderAll);
    radiusFilter.addEventListener("change", renderAll);
    viewFilter.addEventListener("change", renderAll);
    setInterval(()=>{ renderAll(); }, 7000);

    await loadInitial();

    sb.channel("driver-trips-live")
      .on("postgres_changes", { event:"INSERT", schema:"public", table:"driver_trips" }, (p)=>{
        const t = p.new;
        if (!t?.id) return;
        store.set(t.id, t);
        renderAll();
        if (t.status === "requested") toast("üöï Nouvelle demande !");
      })
      .on("postgres_changes", { event:"UPDATE", schema:"public", table:"driver_trips" }, (p)=>{
        const t = p.new;
        if (!t?.id) return;
        if (["requested","accepted","ongoing"].includes(t.status)) store.set(t.id, t);
        else store.delete(t.id);
        renderAll();
      })
      .subscribe();
  }

  main();
</script>
</body>
</html>
